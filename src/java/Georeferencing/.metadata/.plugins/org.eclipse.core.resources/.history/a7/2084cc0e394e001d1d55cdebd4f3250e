package ca.cidco.csb.ppp;

import java.io.BufferedOutputStream;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

public class NrcanPPP {
    //Path to NRCAN script	
	private static String pppPath= "/home/dominic/eclipse_ubx/csrs_ppp_auto_v1_6_1/csrs_ppp_auto.py";
	private static String nrcanUsername= "dominic.gonthier@cidco.ca";
	
	
	public static PppFile fetchPPP(String ubxFilePath) throws Exception{		
		
		System.err.println("Converting UBX file " + ubxFilePath);

		// Get file in commandline argument
        File ubxFile = new File(ubxFilePath);
        String fileName= ubxFile.getName();
        String nameNoExt= fileName.replaceAll(".ubx", "");
        nameNoExt = nameNoExt.replaceAll("\\.", "_");
        String ubxFileDirectory= ubxFile.getParent();
        
        // Make working directory and sub-directories 
        String workingDirectoryName 	= ubxFileDirectory + File.separator + nameNoExt;
        String directoryRinexName 		= ubxFileDirectory + File.separator + nameNoExt + File.separator + "Rinex";
        String pppDirectoryName 		= ubxFileDirectory + File.separator + nameNoExt + File.separator + "ppp";
        
        File workingDirectory = new File(workingDirectoryName);
        File directoryRinex = new File(directoryRinexName);
        File directoryPpp = new File(pppDirectoryName);
        
        ArrayList<File> toMake = new ArrayList<File>(Arrays.asList(workingDirectory, directoryRinex, directoryPpp));
        
        for (File file : toMake) {
        	file.mkdir();
        }

        // Use convbin to generate .obs file      
        System.err.println("Generating OBS file in " + directoryRinexName);
        ProcessBuilder processObsBuilder= new ProcessBuilder("convbin", "-r", "ubx","-d", directoryRinexName, ubxFilePath);
        processObsBuilder.inheritIO();
        Process processOBS= processObsBuilder.start();
        processOBS.waitFor();
        
        // Send .obs to NRCAN
        System.err.println("Fetching PPP data from NRCAN in " + pppDirectoryName);
        
        //Rename OBS file to avoid name-chopping by NRCAN's PPP service
        String oldObsFileName = directoryRinexName + File.separator + fileName.replaceAll(".ubx", "")+".obs";
        String newObsFileName = directoryRinexName + File.separator + nameNoExt+".obs";
        File oldObs = new File(oldObsFileName);
        File newObs = new File(newObsFileName);
        oldObs.renameTo(newObs);
      
        //Send it
        ProcessBuilder processBuilderPPP = new ProcessBuilder("python3", pppPath,"--user_name",nrcanUsername, "--rnx", newObsFileName, "--results_dir", pppDirectoryName);
        processBuilderPPP.inheritIO();
        Process processPPP= processBuilderPPP.start();
        processPPP.waitFor();		
        
        //unzip NRCAN file
        String zipFilePath = pppDirectoryName + File.separator + nameNoExt + "_full_output.zip";
        System.err.println("Unzipping PPP results in " + zipFilePath);
        
        ZipInputStream zipIn = new ZipInputStream(new FileInputStream(zipFilePath));
        ZipEntry entry = zipIn.getNextEntry();
        
        // iterates over entries in the zip file
        while (entry != null) {
            String filePath = pppDirectoryName + File.separator + entry.getName();
            if (!entry.isDirectory()) {
                // if the entry is a file, extracts it
                BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(filePath));
                byte[] bytesIn = new byte[4096];
                int read = 0;
                while ((read = zipIn.read(bytesIn)) != -1) {
                    bos.write(bytesIn, 0, read);
                }
                bos.close();
            } else {
                // if the entry is a directory, make the directory
                File dir = new File(filePath);
                dir.mkdirs();
            }
            zipIn.closeEntry();
            entry = zipIn.getNextEntry();
        }
        zipIn.close();        
       
        //Extract PPP data
        String pppPosFileName = pppDirectoryName + File.separator + nameNoExt + ".pos";
        
        File pppFile = new File(pppPosFileName);

        PppFile ppp = new PppFile();
        int date= 0 ; 
        int time= 0 ;
        int nsv= 0 ;
        int gdop = 0;
        int sdlat = 0;
        int sdlon = 0;
        int sdhgt = 0;
        PppHeader header;
        
		try (FileReader fileReaderData = new FileReader(pppFile)) {
			BufferedReader bufferedReader = new BufferedReader(fileReaderData);
			String row;
			String[] split_row;
			PppPosition position;
        		
    		while ((row = bufferedReader.readLine()) !=null )  {
    			split_row= row.split("[\\s]{1,}");
    			if(split_row[0].equalsIgnoreCase("DIR")){
    				header = new PppHeader(row);
    			} 
    			else if(split_row[0].equalsIgnoreCase("FWD")|split_row[0].equalsIgnoreCase("FIN")|split_row[0].equalsIgnoreCase("FIX")){
    				position= new PppPosition(split_row[header.getDate()], split_row[header.getTime()], split_row[header.getNsv()], split_row[header.getGdop()], split_row[header.getSdlat()], split_row[header.getSdlon()], split_row[header.getSdhgt()]);
					ppp.add(position);
				}
    		}
		}
		
		catch (IOException e) {
			e.printStackTrace();
			}

  
        System.err.println("PPP done");

        return ppp;
	}
}